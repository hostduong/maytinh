{{ define "dang_ky" }}
    {{ template "header" . }}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .iti { width: 100%; }
        input::-ms-reveal, input::-ms-clear { display: none; }
        
        /* CSS Validation chuy√™n nghi·ªáp */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2; }
        .input-success { border-color: #22c55e !important; background-color: #f0fdf4; }
        .input-normal { border-color: #d1d5db !important; background-color: #ffffff; }
        
        .error-text { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; display: none; }
        .error-text.show { display: block; }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; background-color: #9ca3af !important; box-shadow: none; }
    </style>

    <div class="flex items-center justify-center min-h-[calc(100vh-200px)] py-12 px-4 bg-gray-50">
        <div class="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-green-600">ƒêƒÉng K√Ω Th√†nh Vi√™n</h2>
                <p class="mt-2 text-sm text-gray-600">H·ªá th·ªëng MayTinhShop</p>
            </div>

            {{ if .Loi }}
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    Swal.fire({ icon: 'error', title: 'L·ªói', text: '{{ .Loi }}' });
                });
            </script>
            {{ end }}

            <form id="formDangKy" action="/register" method="POST" novalidate class="space-y-5">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                        <input id="ho_ten" name="ho_ten" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition input-normal" placeholder="Nguy·ªÖn VƒÉn A">
                        <p id="err_ho_ten" class="error-text">H·ªç t√™n 6-50 k√Ω t·ª±, kh√¥ng ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± l·∫°.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªõi t√≠nh</label>
                        <select name="gioi_tinh" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-green-500">
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y sinh</label>
                        <input id="ngay_sinh" name="ngay_sinh" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒêi·ªán tho·∫°i</label>
                        <input id="dien_thoai" name="dien_thoai" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <p id="err_dien_thoai" class="error-text">S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.</p>
                        <input type="hidden" name="dien_thoai_full" id="dien_thoai_full">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                        <input id="email" name="email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-normal" placeholder="abc@gmail.com">
                        <p id="err_email" class="error-text">Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (VD: abc@mail.com).</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√£ PIN (8 s·ªë) <span class="text-red-500">*</span></label>
                        <input id="ma_pin" name="ma_pin" type="text" maxlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-normal" placeholder="12345678">
                        <p id="err_ma_pin" class="error-text">M√£ PIN ph·∫£i ƒë√∫ng 8 ch·ªØ s·ªë.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p <span class="text-red-500">*</span></label>
                    <input id="ten_dang_nhap" name="ten_dang_nhap" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-normal" placeholder="user123">
                    <p id="err_ten_dang_nhap" class="error-text">6-30 k√Ω t·ª± (a-z, 0-9, ., _). Kh√¥ng b·∫Øt ƒë·∫ßu/k·∫øt th√∫c b·∫±ng k√Ω t·ª± ƒë·∫∑c bi·ªát.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="mat_khau" name="mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-normal" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_mat_khau" class="error-text">8-30 k√Ω t·ª±. Ch·ªâ g·ªìm ch·ªØ, s·ªë v√† !@#$%^&*()-_+.,?</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="re_mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 input-normal" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('re_mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_re_mat_khau" class="error-text">M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="terms" name="terms" type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="terms" class="font-medium text-gray-700 cursor-pointer">T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="text-green-600 hover:underline">ƒêi·ªÅu kho·∫£n</a></label>
                    </div>
                </div>
                <div class="pt-2">
                    <button type="submit" id="btnSubmit" disabled
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-green-600 hover:bg-green-700 shadow-lg transition transform active:scale-95">
                        ƒêƒÇNG K√ù NGAY
                    </button>
                </div>
                <div class="text-center text-sm mt-4">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="/login" class="font-medium text-blue-600 hover:text-blue-500">ƒêƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        const inputPhone = document.querySelector("#dien_thoai");
        const iti = window.intlTelInput(inputPhone, { initialCountry: "vn", separateDialCode: true, utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" });

        // [C·∫§U H√åNH REGEX THEO Y√äU C·∫¶U]
        const RULES = {
            ho_ten: {
                // Regex 1: Ch·∫∑n k√Ω t·ª± l·∫° (Input) - Cho ph√©p ch·ªØ + kho·∫£ng tr·∫Øng
                char_regex: /[^\p{L}\s]/u, 
                // Regex 2: Full check (Blur) - ƒê·ªô d√†i 6-50
                full_regex: /^[\p{L}\s]{6,50}$/u,
                msg: "H·ªç t√™n 6-50 k√Ω t·ª±, kh√¥ng ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± l·∫°."
            },
            email: {
                // Input: Cho ph√©p a-z 0-9 . _ % + - @
                char_regex: /[^a-z0-9._%+\-@]/, 
                // Blur: Full format email + Ch·∫∑n @mail..com
                full_regex: /^[a-z0-9._%+\-]+@(?:[a-z0-9-]+\.)+[a-z]{2,}$/, 
                // ƒê·ªô d√†i ki·ªÉm tra ri√™ng b·∫±ng length (6-100)
                msg: "Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (VD: abc@mail.com)."
            },
            ma_pin: {
                char_regex: /[^0-9]/,
                full_regex: /^\d{8}$/,
                msg: "M√£ PIN ph·∫£i ƒë√∫ng 8 s·ªë."
            },
            ten_dang_nhap: {
                // Input: a-z 0-9 . _
                char_regex: /[^a-z0-9._]/,
                // Blur: Regex Lookahead ch·∫∑n .. __ ._ _.
                full_regex: /^[a-z0-9](?!.*(\.\.|__|_\.|\._))[a-z0-9._]{4,28}[a-z0-9]$/,
                msg: "6-30 k√Ω t·ª± (a-z, 0-9, ., _). Kh√¥ng b·∫Øt ƒë·∫ßu/k·∫øt th√∫c b·∫±ng . _ v√† kh√¥ng ch·ª©a .. __ ._"
            },
            mat_khau: {
                // Input: Whitelist k√Ω t·ª±
                char_regex: /[^a-zA-Z0-9!@#$%^&*()\-+_.,?]/,
                // Blur: Check ƒë·ªô d√†i
                full_regex: /^[a-zA-Z0-9!@#$%^&*()\-+_.,?]{8,30}$/,
                msg: "8-30 k√Ω t·ª±. Ch·ªâ g·ªìm ch·ªØ, s·ªë v√† !@#$%^&*()-_+.,?"
            }
        };

        function setError(id, isError) {
            const input = document.getElementById(id);
            const msg = document.getElementById('err_' + id);
            if (isError) {
                input.classList.add('input-error');
                input.classList.remove('input-success', 'input-normal');
                msg.classList.add('show');
            } else {
                input.classList.remove('input-error');
                if (input.value.trim() !== "") input.classList.add('input-success');
                else input.classList.add('input-normal');
                msg.classList.remove('show');
            }
            checkSubmitButton();
        }

        // LOGIC 1: Ki·ªÉm tra k√Ω t·ª± ngay khi nh·∫≠p (INPUT)
        function handleInput(id) {
            const el = document.getElementById(id);
            const rule = RULES[id];
            
            // Auto lowercase
            if (id === 'email' || id === 'ten_dang_nhap') el.value = el.value.toLowerCase();
            
            const val = el.value;
            // N·∫øu ch·ª©a k√Ω t·ª± c·∫•m -> B√°o l·ªói NGAY L·∫¨P T·ª®C
            if (val !== "" && rule.char_regex.test(val)) {
                setError(id, true);
            } else {
                // N·∫øu k√Ω t·ª± ·ªïn -> T·∫Øt l·ªói t·∫°m th·ªùi (Ch∆∞a check ƒë·ªô d√†i v·ªôi ƒë·ªÉ ƒë·ª° phi·ªÅn user)
                // Tr·ª´ khi √¥ ƒëang tr·ªëng th√¨ v·ªÅ normal
                if (val === "") {
                    el.classList.remove('input-error', 'input-success');
                    el.classList.add('input-normal');
                    document.getElementById('err_' + id).classList.remove('show');
                } else {
                    // X√≥a l·ªói ƒë·ªè nh∆∞ng ch∆∞a xanh h·∫≥n (ƒë·ªÉ ch·ªù blur check full)
                    el.classList.remove('input-error');
                    document.getElementById('err_' + id).classList.remove('show');
                }
            }
            checkSubmitButton();
        }

        // LOGIC 2: Ki·ªÉm tra to√†n di·ªán khi r·ªùi chu·ªôt (BLUR)
        function handleBlur(id) {
            const el = document.getElementById(id);
            const val = el.value.trim();
            const rule = RULES[id];

            if (val === "") return; // R·ªóng th√¨ th√¥i

            // 1. Check ƒë·ªô d√†i Email th·ªß c√¥ng
            if (id === 'email') {
                if (val.length < 6 || val.length > 100) {
                    setError(id, true); return;
                }
            }

            // 2. Check Regex Full
            if (!rule.full_regex.test(val)) {
                setError(id, true);
            } else {
                setError(id, false); // Th√†nh c√¥ng -> Xanh
            }
        }

        // G·∫Øn Event
        Object.keys(RULES).forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', () => handleInput(id));
            el.addEventListener('blur', () => handleBlur(id));
        });

        // X·ª≠ l√Ω Re-Pass
        const rePass = document.getElementById('re_mat_khau');
        const pass = document.getElementById('mat_khau');
        rePass.addEventListener('input', function() {
            // Check k√Ω t·ª± l·∫° password
            if (/[^a-zA-Z0-9!@#$%^&*()\-+_.,?]/.test(this.value)) setError('re_mat_khau', true);
            else {
                document.getElementById('err_re_mat_khau').classList.remove('show');
                this.classList.remove('input-error');
            }
            checkSubmitButton();
        });
        rePass.addEventListener('blur', function() {
            if (this.value !== "" && this.value !== pass.value) setError('re_mat_khau', true);
            else if (this.value !== "") setError('re_mat_khau', false);
        });

        // X·ª≠ l√Ω Phone
        inputPhone.addEventListener('blur', () => {
            const val = inputPhone.value.trim();
            const err = document.getElementById('err_dien_thoai');
            if (val !== "") {
                if (!iti.isValidNumber()) { 
                    inputPhone.classList.add('input-error'); inputPhone.classList.remove('input-success'); err.classList.add('show');
                } else { 
                    inputPhone.classList.add('input-success'); inputPhone.classList.remove('input-error'); err.classList.remove('show');
                }
            }
            checkSubmitButton();
        });

        function checkSubmitButton() {
            const requiredIds = ['ho_ten', 'email', 'ma_pin', 'ten_dang_nhap', 'mat_khau', 're_mat_khau'];
            let allGreen = true;
            for (const id of requiredIds) { 
                if (!document.getElementById(id).classList.contains('input-success')) { allGreen = false; break; } 
            }
            const terms = document.getElementById('terms').checked;
            let phoneOk = true; 
            if (inputPhone.value.trim() !== "" && !iti.isValidNumber()) phoneOk = false;

            const btn = document.getElementById('btnSubmit');
            if (allGreen && terms && phoneOk) btn.removeAttribute('disabled'); 
            else btn.setAttribute('disabled', 'true');
        }

        document.getElementById('terms').addEventListener('change', checkSubmitButton);

        document.getElementById('formDangKy').addEventListener('submit', function(e) {
            const btn = document.getElementById('btnSubmit');
            if (btn.disabled) { e.preventDefault(); return; }
            if(inputPhone.value.trim() !== "") document.getElementById("dien_thoai_full").value = iti.getNumber();
            btn.setAttribute('disabled', 'true');
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ƒêang x·ª≠ l√Ω...`;
        });

        function togglePass(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }
    </script>

    {{ template "footer" . }}
{{ end }}
