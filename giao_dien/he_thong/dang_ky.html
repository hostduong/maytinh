{{ define "dang_ky" }}
    {{ template "header" . }}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .iti { width: 100%; }
        input::-ms-reveal, input::-ms-clear { display: none; }
        /* Style cho n√∫t disable */
        button:disabled { opacity: 0.6; cursor: not-allowed; background-color: #9ca3af; }
    </style>

    <div class="flex items-center justify-center min-h-[calc(100vh-200px)] py-12 px-4 bg-gray-50">
        <div class="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-green-600">ƒêƒÉng K√Ω Th√†nh Vi√™n</h2>
                <p class="mt-2 text-sm text-gray-600">H·ªá th·ªëng MayTinhShop</p>
            </div>

            {{ if .Loi }}
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    Swal.fire({ icon: 'error', title: 'L·ªói', text: '{{ .Loi }}' });
                });
            </script>
            {{ end }}

            <form id="formDangKy" action="/register" method="POST" novalidate class="space-y-5">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                        <input id="ho_ten" name="ho_ten" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="Nguy·ªÖn VƒÉn A">
                        <p id="err_ho_ten" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªõi t√≠nh</label>
                        <select name="gioi_tinh" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-green-500">
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y sinh</label>
                        <input id="ngay_sinh" name="ngay_sinh" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒêi·ªán tho·∫°i</label>
                        <input id="dien_thoai" name="dien_thoai" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <p id="err_dien_thoai" class="text-red-500 text-xs mt-1 hidden"></p>
                        <input type="hidden" name="dien_thoai_full" id="dien_thoai_full">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                        <input id="email" name="email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="abc@gmail.com">
                        <p id="err_email" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√£ PIN (8 s·ªë) <span class="text-red-500">*</span></label>
                        <input id="ma_pin" name="ma_pin" type="text" maxlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="12345678">
                        <p id="err_ma_pin" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p <span class="text-red-500">*</span></label>
                    <input id="ten_dang_nhap" name="ten_dang_nhap" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="user123">
                    <p id="err_ten_dang_nhap" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="mat_khau" name="mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="re_mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('re_mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_re_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="terms" name="terms" type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="terms" class="font-medium text-gray-700 cursor-pointer">T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="text-green-600 hover:underline">ƒêi·ªÅu kho·∫£n</a></label>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" id="btnSubmit" disabled
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-green-600 hover:bg-green-700 shadow-lg transition transform active:scale-95">
                        ƒêƒÇNG K√ù NGAY
                    </button>
                </div>

                <div class="text-center text-sm mt-4">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="/login" class="font-medium text-blue-600 hover:text-blue-500">ƒêƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 1. INPUT PHONE
        const inputPhone = document.querySelector("#dien_thoai");
        const iti = window.intlTelInput(inputPhone, {
            initialCountry: "vn",
            separateDialCode: true,
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
        });

        // 2. RULES
        const RULES = {
            ho_ten: {
                forbidden: /[0-9!@#$%^&*(),.?":{}|<>]/, // C·∫•m s·ªë v√† k√Ω t·ª± l·∫°
                validate: val => val.trim().length >= 6 && val.trim().length <= 50,
                msg_forbidden: "H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát.",
                msg_invalid: "H·ªç t√™n ph·∫£i t·ª´ 6 - 50 k√Ω t·ª±."
            },
            email: {
                forbidden: /\s/, // C·∫•m d·∫•u c√°ch
                validate: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val),
                msg_forbidden: "Email kh√¥ng ƒë∆∞·ª£c ch·ª©a d·∫•u c√°ch.",
                msg_invalid: "ƒê·ªãnh d·∫°ng Email kh√¥ng h·ª£p l·ªá."
            },
            ma_pin: {
                forbidden: /[^0-9]/, // C·∫•m ch·ªØ
                validate: val => /^\d{8}$/.test(val),
                msg_forbidden: "M√£ PIN ch·ªâ ƒë∆∞·ª£c nh·∫≠p s·ªë.",
                msg_invalid: "M√£ PIN ph·∫£i ƒë√∫ng 8 s·ªë."
            },
            ten_dang_nhap: {
                forbidden: /[^a-z0-9._]/, // C·∫•m ch·ªØ hoa, d·∫•u c√°ch, k√Ω t·ª± l·∫°
                validate: val => val.length >= 6 && val.length <= 30,
                msg_forbidden: "Ch·ªâ nh·∫≠p ch·ªØ th∆∞·ªùng, s·ªë, d·∫•u . v√† _",
                msg_invalid: "T√™n ƒëƒÉng nh·∫≠p t·ª´ 6 - 30 k√Ω t·ª±."
            },
            mat_khau: {
                forbidden: /[\s'"<>]/, // C·∫•m d·∫•u c√°ch, nh√°y, ngo·∫∑c
                validate: val => val.length >= 8 && val.length <= 30,
                msg_forbidden: "Kh√¥ng ƒë∆∞·ª£c ch·ª©a kho·∫£ng tr·∫Øng ho·∫∑c ' \" < >",
                msg_invalid: "M·∫≠t kh·∫©u ph·∫£i t·ª´ 8 - 30 k√Ω t·ª±."
            }
        };

        // 3. H√ÄM HI·ªÇN TH·ªä TR·∫†NG TH√ÅI
        function setError(id, msg) {
            const el = document.getElementById(id);
            const err = document.getElementById('err_' + id);
            el.classList.add('border-red-500', 'focus:ring-red-500');
            el.classList.remove('border-green-500', 'focus:ring-green-500', 'border-gray-300');
            err.innerText = msg;
            err.classList.remove('hidden');
        }

        function setSuccess(id) {
            const el = document.getElementById(id);
            const err = document.getElementById('err_' + id);
            el.classList.remove('border-red-500', 'focus:ring-red-500', 'border-gray-300');
            el.classList.add('border-green-500', 'focus:ring-green-500');
            err.classList.add('hidden');
        }

        function setNormal(id) {
            const el = document.getElementById(id);
            const err = document.getElementById('err_' + id);
            el.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500');
            el.classList.add('border-gray-300');
            err.classList.add('hidden');
        }

        // 4. CHECK T·ªîNG TH·ªÇ ƒê·ªÇ B·∫¨T N√öT
        function checkSubmitButton() {
            // Ki·ªÉm tra xem c√≥ √¥ n√†o ƒëang b·ªã l·ªói ƒë·ªè kh√¥ng
            const hasError = document.querySelectorAll('.border-red-500').length > 0;
            
            // Ki·ªÉm tra c√°c √¥ b·∫Øt bu·ªôc c√≥ b·ªã r·ªóng kh√¥ng
            const requiredIds = ['ho_ten', 'email', 'ma_pin', 'ten_dang_nhap', 'mat_khau', 're_mat_khau'];
            const hasEmpty = requiredIds.some(id => document.getElementById(id).value.trim() === "");

            // Ki·ªÉm tra checkbox
            const terms = document.getElementById('terms').checked;

            // Ki·ªÉm tra pass kh·ªõp
            const p1 = document.getElementById('mat_khau').value;
            const p2 = document.getElementById('re_mat_khau').value;
            const passMatch = (p1 === p2 && p1 !== "");

            // Logic ƒëi·ªán tho·∫°i (n·∫øu nh·∫≠p th√¨ ph·∫£i ƒë√∫ng)
            let phoneOk = true;
            if (inputPhone.value.trim() !== "" && !iti.isValidNumber()) phoneOk = false;

            const btn = document.getElementById('btnSubmit');
            if (!hasError && !hasEmpty && terms && passMatch && phoneOk) {
                btn.removeAttribute('disabled');
            } else {
                btn.setAttribute('disabled', 'true');
            }
        }

        // 5. G·∫ÆN S·ª∞ KI·ªÜN T·ª™NG √î
        Object.keys(RULES).forEach(id => {
            const el = document.getElementById(id);
            const rule = RULES[id];

            // S·ª∞ KI·ªÜN G√ï (INPUT): B√°o l·ªói ngay n·∫øu k√Ω t·ª± c·∫•m, X√≥a l·ªói n·∫øu ƒëang g√µ ƒë√∫ng
            el.addEventListener('input', function() {
                if (rule.forbidden.test(this.value)) {
                    setError(id, rule.msg_forbidden); // 1. Nh·∫≠p sai -> Hi·ªán c·∫£nh b√°o ngay
                } else {
                    setNormal(id); // 2. ƒêang nh·∫≠p ƒë√∫ng -> Kh√¥ng hi·ªán c·∫£nh b√°o (Reset v·ªÅ b√¨nh th∆∞·ªùng)
                }
                checkSubmitButton();
            });

            // S·ª∞ KI·ªÜN BLUR: Ki·ªÉm tra ƒë·ªô d√†i/ƒë·ªãnh d·∫°ng khi nh·∫≠p xong
            el.addEventListener('blur', function() {
                if (this.value === "") return; // R·ªóng th√¨ th√¥i (ƒë·ªÉ check t·ªïng th·ªÉ lo)
                
                if (!rule.validate(this.value)) {
                    setError(id, rule.msg_invalid); // 3. Nh·∫≠p xong thi·∫øu k√Ω t·ª± -> Hi·ªán c·∫£nh b√°o
                } else {
                    setSuccess(id);
                }
                checkSubmitButton();
            });
        });

        // X·ª≠ l√Ω ri√™ng Re-Pass
        const rePass = document.getElementById('re_mat_khau');
        const pass = document.getElementById('mat_khau');
        
        rePass.addEventListener('input', () => {
            setNormal('re_mat_khau');
            checkSubmitButton();
        });
        
        rePass.addEventListener('blur', () => {
            if (rePass.value !== "" && rePass.value !== pass.value) {
                setError('re_mat_khau', "M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.");
            } else if (rePass.value !== "") {
                setSuccess('re_mat_khau');
            }
            checkSubmitButton();
        });

        // X·ª≠ l√Ω ri√™ng ƒêi·ªán tho·∫°i
        inputPhone.addEventListener('blur', () => {
            if (inputPhone.value.trim() !== "") {
                if (!iti.isValidNumber()) {
                    inputPhone.classList.add('border-red-500');
                    document.getElementById('err_dien_thoai').innerText = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá";
                    document.getElementById('err_dien_thoai').classList.remove('hidden');
                } else {
                    inputPhone.classList.remove('border-red-500');
                    inputPhone.classList.add('border-green-500');
                    document.getElementById('err_dien_thoai').classList.add('hidden');
                }
            } else {
                inputPhone.classList.remove('border-red-500', 'border-green-500');
            }
            checkSubmitButton();
        });

        // Checkbox Terms
        document.getElementById('terms').addEventListener('change', checkSubmitButton);

        // FORM SUBMIT
        document.getElementById('formDangKy').addEventListener('submit', function(e) {
            if (document.getElementById('btnSubmit').disabled) {
                e.preventDefault();
                return;
            }
            // G√°n s·ªë full tr∆∞·ªõc khi g·ª≠i
            if(inputPhone.value.trim() !== "") {
                document.getElementById("dien_thoai_full").value = iti.getNumber();
            }
        });

        function togglePass(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }
    </script>

    {{ template "footer" . }}
{{ end }}
