{{ define "dang_ky" }}
    {{ template "header" . }}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .iti { width: 100%; }
        /* ·∫®n icon m·∫Øt m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát ƒë·ªÉ d√πng icon custom */
        input::-ms-reveal, input::-ms-clear { display: none; }
    </style>

    <div class="flex items-center justify-center min-h-[calc(100vh-200px)] py-12 px-4 sm:px-6 lg:px-8 bg-gray-50">
        <div class="w-full max-w-2xl space-y-6 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
            
            <div class="text-center">
                <h2 class="text-3xl font-bold text-green-600">ƒêƒÉng K√Ω Th√†nh Vi√™n</h2>
                <p class="mt-2 text-sm text-gray-600">Tham gia h·ªá th·ªëng MayTinhShop</p>
            </div>

            {{ if .Loi }}
            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded text-sm flex items-center shadow-sm">
                <span class="mr-2 text-lg">‚ö†Ô∏è</span> {{ .Loi }}
            </div>
            {{ end }}

            <form id="formDangKy" class="mt-8 space-y-5" action="/register" method="POST" novalidate>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                        <input id="ho_ten" name="ho_ten" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="Nguy·ªÖn VƒÉn A">
                        <p id="err_ho_ten" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªõi t√≠nh</label>
                        <select name="gioi_tinh" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition bg-white">
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y sinh</label>
                        <input id="ngay_sinh" name="ngay_sinh" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition text-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒêi·ªán tho·∫°i (T√πy ch·ªçn)</label>
                        <input id="dien_thoai" name="dien_thoai" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                        <p id="err_dien_thoai" class="text-red-500 text-xs mt-1 hidden"></p>
                        <input type="hidden" name="dien_thoai_full" id="dien_thoai_full">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                        <input id="email" name="email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="abc@gmail.com">
                        <p id="err_email" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√£ PIN (8 s·ªë) <span class="text-red-500">*</span></label>
                        <input id="ma_pin" name="ma_pin" type="text" maxlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="12345678">
                        <p id="err_ma_pin" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p <span class="text-red-500">*</span></label>
                    <input id="ten_dang_nhap" name="ten_dang_nhap" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="user123 (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng c√°ch)">
                    <p id="err_ten_dang_nhap" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="mat_khau" name="mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input id="re_mat_khau" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePass('re_mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400">üëÅÔ∏è</button>
                        </div>
                        <p id="err_re_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="terms" name="terms" type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500 transition cursor-pointer">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="terms" class="font-medium text-gray-700 cursor-pointer">T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="text-green-600 hover:underline">ƒêi·ªÅu kho·∫£n v√† ƒëi·ªÅu ki·ªán</a></label>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" id="btnSubmit" disabled
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white 
                               bg-gray-400 cursor-not-allowed transition transform 
                               disabled:opacity-70 disabled:bg-gray-400 
                               enabled:bg-green-600 enabled:hover:bg-green-700 enabled:active:scale-95 enabled:shadow-lg enabled:cursor-pointer">
                        ƒêƒÇNG K√ù NGAY
                    </button>
                </div>

                <div class="text-center text-sm mt-4">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="/login" class="font-medium text-blue-600 hover:text-blue-500">ƒêƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 1. C·∫§U H√åNH ƒêI·ªÜN THO·∫†I
        const inputPhone = document.querySelector("#dien_thoai");
        const iti = window.intlTelInput(inputPhone, {
            initialCountry: "vn",
            separateDialCode: true,
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
        });

        // 2. B·ªò LU·∫¨T VALIDATION (Regex ch·∫∑t h∆°n)
        // - H·ªç t√™n: Ch·ªâ ch·ªØ c√°i Unicode (Ti·∫øng Vi·ªát) v√† kho·∫£ng tr·∫Øng. Kh√¥ng s·ªë, kh√¥ng k√Ω t·ª± ƒë·∫∑c bi·ªát.
        // - Username: Ch·ªâ ch·ªØ th∆∞·ªùng a-z, s·ªë 0-9, d·∫•u ch·∫•m, g·∫°ch d∆∞·ªõi. Kh√¥ng in hoa, kh√¥ng @.
        const VALIDATOR = {
            ho_ten: {
                // Regex: Ch·ªâ cho ph√©p ch·ªØ c√°i (bao g·ªìm ti·∫øng Vi·ªát) v√† kho·∫£ng tr·∫Øng. C·∫•m s·ªë.
                regex: /^[a-zA-Z√Ä-·ªπ\s]+$/, 
                validate: val => val.trim().length >= 6 && val.trim().length <= 50 && /^[a-zA-Z√Ä-·ªπ\s]+$/.test(val),
                msg: "H·ªç t√™n ph·∫£i l√† ch·ªØ c√°i, t·ª´ 6-50 k√Ω t·ª±."
            },
            email: {
                // Regex Email chu·∫©n
                regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                validate: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) && val.length >= 6 && val.length <= 100,
                msg: "Email kh√¥ng h·ª£p l·ªá."
            },
            ma_pin: {
                regex: /^\d+$/,
                validate: val => /^\d{8}$/.test(val),
                msg: "M√£ PIN ph·∫£i l√† 8 ch·ªØ s·ªë."
            },
            ten_dang_nhap: {
                // Ch·ªâ ch·ªØ th∆∞·ªùng, s·ªë, ., _
                regex: /^[a-z0-9._]+$/,
                validate: val => /^[a-z0-9._]+$/.test(val) && val.length >= 6 && val.length <= 30,
                msg: "User t·ª´ 6-30 k√Ω t·ª± (ch·ªØ th∆∞·ªùng, s·ªë, d·∫•u . _)"
            },
            mat_khau: {
                regex: /^[^'"<>\s]+$/,
                validate: val => val.length >= 8 && val.length <= 30 && !/['"<>\s]/.test(val),
                msg: "M·∫≠t kh·∫©u 8-30 k√Ω t·ª±, kh√¥ng c√≥ kho·∫£ng tr·∫Øng."
            }
        };

        // 3. H√ÄM KI·ªÇM TRA TR·∫†NG TH√ÅI INPUT
        function validateField(id) {
            const input = document.getElementById(id);
            const msg = document.getElementById('err_' + id);
            const val = input.value;
            const rule = VALIDATOR[id];

            // Reset style
            input.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500', 'border-gray-300');
            msg.classList.add('hidden');

            if (val === "") {
                // R·ªóng -> Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (x√°m)
                input.classList.add('border-gray-300', 'focus:ring-green-500');
                return false;
            }

            if (!rule.validate(val)) {
                // L·ªói -> ƒê·ªè
                input.classList.add('border-red-500', 'focus:ring-red-500');
                msg.innerText = rule.msg;
                msg.classList.remove('hidden');
                return false;
            } else {
                // ƒê√∫ng -> Xanh
                input.classList.add('border-green-500', 'focus:ring-green-500');
                return true;
            }
        }

        // 4. KI·ªÇM TRA TO√ÄN B·ªò FORM ƒê·ªÇ B·∫¨T N√öT SUBMIT
        function checkFormValidity() {
            const isNameOk = validateField('ho_ten');
            const isEmailOk = validateField('email');
            const isPinOk = validateField('ma_pin');
            const isUserOk = validateField('ten_dang_nhap');
            const isPassOk = validateField('mat_khau');
            
            // Re-pass check
            const p1 = document.getElementById('mat_khau').value;
            const p2 = document.getElementById('re_mat_khau').value;
            const isRePassOk = (p1 !== "" && p1 === p2);
            // Style cho √¥ Re-pass
            const reInput = document.getElementById('re_mat_khau');
            reInput.classList.remove('border-green-500', 'border-red-500', 'border-gray-300');
            if(p2 === "") reInput.classList.add('border-gray-300');
            else if(isRePassOk) reInput.classList.add('border-green-500');
            else {
                reInput.classList.add('border-red-500');
                document.getElementById('err_re_mat_khau').innerText = "M·∫≠t kh·∫©u kh√¥ng kh·ªõp";
                document.getElementById('err_re_mat_khau').classList.remove('hidden');
            }
            if(isRePassOk) document.getElementById('err_re_mat_khau').classList.add('hidden');

            // Phone check (Optional)
            let isPhoneOk = true;
            if (inputPhone.value.trim() !== "") {
                isPhoneOk = iti.isValidNumber();
                inputPhone.classList.toggle('border-red-500', !isPhoneOk);
                inputPhone.classList.toggle('border-green-500', isPhoneOk);
            } else {
                inputPhone.classList.remove('border-red-500', 'border-green-500');
                inputPhone.classList.add('border-gray-300');
            }

            // Checkbox
            const isTermsOk = document.getElementById('terms').checked;

            // K·∫æT LU·∫¨N: B·∫≠t hay T·∫Øt n√∫t Submit
            const btn = document.getElementById('btnSubmit');
            if (isNameOk && isEmailOk && isPinOk && isUserOk && isPassOk && isRePassOk && isPhoneOk && isTermsOk) {
                btn.removeAttribute('disabled');
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                btn.setAttribute('disabled', 'true');
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            }
        }

        // 5. G·∫ÆN S·ª∞ KI·ªÜN CHO C√ÅC INPUT
        // G·∫Øn s·ª± ki·ªán 'input' ƒë·ªÉ check ngay khi g√µ
        ['ho_ten', 'email', 'ma_pin', 'ten_dang_nhap', 'mat_khau'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => checkFormValidity());
        });
        document.getElementById('re_mat_khau').addEventListener('input', () => checkFormValidity());
        document.getElementById('terms').addEventListener('change', () => checkFormValidity());
        inputPhone.addEventListener('input', () => checkFormValidity());

        // 6. X·ª¨ L√ù SUBMIT
        document.getElementById('formDangKy').addEventListener('submit', function(e) {
            e.preventDefault(); // Ch·∫∑n g·ª≠i m·∫∑c ƒë·ªãnh ƒë·ªÉ check l·∫ßn cu·ªëi

            // L∆∞u s·ªë ƒëi·ªán tho·∫°i ƒë·∫ßy ƒë·ªß (VD: +84...) v√†o input ·∫©n
            if(inputPhone.value.trim() !== "") {
                document.getElementById("dien_thoai_full").value = iti.getNumber();
            }

            // N·∫øu n√∫t kh√¥ng disabled th√¨ m·ªõi submit
            if (!document.getElementById('btnSubmit').disabled) {
                this.submit();
            } else {
                // Tr∆∞·ªùng h·ª£p hack b·ªè disabled, hi·ªán SweetAlert c·∫£nh b√°o
                Swal.fire({
                    icon: 'error',
                    title: 'Ch∆∞a ƒë·ªß th√¥ng tin',
                    text: 'Vui l√≤ng ki·ªÉm tra l·∫°i c√°c √¥ b√°o ƒë·ªè ho·∫∑c ch∆∞a nh·∫≠p.',
                    confirmButtonColor: '#d33',
                });
            }
        });

        function togglePass(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }
    </script>

    {{ template "footer" . }}
{{ end }}
