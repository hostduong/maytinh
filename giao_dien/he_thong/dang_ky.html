{{ define "dang_ky" }}
    {{ template "header" . }}

    <div class="flex items-center justify-center min-h-[calc(100vh-200px)] py-12 px-4 sm:px-6 lg:px-8 bg-gray-50">
        <div class="w-full max-w-md space-y-6 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-green-600">T·∫°o T√†i Kho·∫£n</h2>
                <p class="mt-2 text-sm text-gray-600">Tr·ªü th√†nh th√†nh vi√™n c·ªßa MayTinhShop</p>
            </div>

            {{ if .Loi }}
            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded text-sm flex items-center shadow-sm">
                <span class="mr-2 text-lg">‚ö†Ô∏è</span> {{ .Loi }}
            </div>
            {{ end }}

            <form id="formDangKy" class="mt-8 space-y-4" action="/register" method="POST" novalidate>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                    <input id="ho_ten" name="ho_ten" type="text" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                        placeholder="Nguy·ªÖn VƒÉn A">
                    <p id="err_ho_ten" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input id="email" name="email" type="email" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                        placeholder="abc@gmail.com">
                    <p id="err_email" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">M√£ PIN (8 s·ªë)</label>
                    <div class="relative">
                        <input id="ma_pin" name="ma_pin" type="text" maxlength="8"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                            placeholder="12345678">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400">üî¢</div>
                    </div>
                    <p id="err_ma_pin" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input id="ten_dang_nhap" name="ten_dang_nhap" type="text" maxlength="30"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                        placeholder="user123">
                    <p id="err_ten_dang_nhap" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
                    <div class="relative">
                        <input id="mat_khau" name="mat_khau" type="password" maxlength="30"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="togglePass('mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">üëÅÔ∏è</button>
                    </div>
                    <p id="err_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
                    <div class="relative">
                        <input id="re_mat_khau" type="password" maxlength="30"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="togglePass('re_mat_khau')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">üëÅÔ∏è</button>
                    </div>
                    <p id="err_re_mat_khau" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>

                <div class="pt-2">
                    <button type="submit" id="btnSubmit"
                        class="group w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-lg shadow-green-500/30 transition transform active:scale-95">
                        ƒêƒÇNG K√ù NGAY
                    </button>
                </div>

                <div class="text-center text-sm mt-4">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="/login" class="font-medium text-blue-600 hover:text-blue-500">ƒêƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH LOGIC KI·ªÇM TRA ===
        const VALIDATOR = {
            ho_ten: {
                forbidden: /[0-9!@#$%^&*(),.?":{}|<>]/, // C·∫•m s·ªë v√† k√Ω t·ª± l·∫°
                validate: val => val.trim().length >= 6 && val.trim().length <= 50,
                msg_forbidden: "H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát.",
                msg_invalid: "H·ªç t√™n ph·∫£i t·ª´ 6 - 50 k√Ω t·ª±."
            },
            email: {
                forbidden: /\s/, // C·∫•m d·∫•u c√°ch
                validate: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) && val.length >= 6 && val.length <= 100,
                msg_forbidden: "Email kh√¥ng ƒë∆∞·ª£c ch·ª©a d·∫•u c√°ch.",
                msg_invalid: "Email kh√¥ng h·ª£p l·ªá (V√≠ d·ª•: abc@gmail.com)."
            },
            ma_pin: {
                forbidden: /[^0-9]/, // C·∫•m ch·ªØ
                validate: val => /^\d{8}$/.test(val),
                msg_forbidden: "M√£ PIN ch·ªâ ƒë∆∞·ª£c nh·∫≠p s·ªë.",
                msg_invalid: "M√£ PIN b·∫Øt bu·ªôc ph·∫£i ƒë·ªß 8 s·ªë."
            },
            ten_dang_nhap: {
                forbidden: /[^a-zA-Z0-9._]/, // C·∫•m k√Ω t·ª± l·∫° ngo√†i a-z 0-9 . _
                validate: val => val.length >= 6 && val.length <= 30,
                msg_forbidden: "Ch·ªâ cho ph√©p ch·ªØ, s·ªë, d·∫•u ch·∫•m (.) v√† g·∫°ch d∆∞·ªõi (_).",
                msg_invalid: "T√™n ƒëƒÉng nh·∫≠p ph·∫£i t·ª´ 6 - 30 k√Ω t·ª±."
            },
            mat_khau: {
                forbidden: /['"<>\s]/, // C·∫•m d·∫•u c√°ch, ' " < >
                validate: val => val.length >= 8 && val.length <= 30,
                msg_forbidden: "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ch·ª©a kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± ' \" < >",
                msg_invalid: "M·∫≠t kh·∫©u ph·∫£i t·ª´ 8 - 30 k√Ω t·ª±."
            }
        };

        // H√†m hi·ªÉn th·ªã tr·∫°ng th√°i (Error/Success/Normal)
        function setStatus(id, status, msgText = "") {
            const input = document.getElementById(id);
            const msg = document.getElementById('err_' + id);

            // Reset classes
            input.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500', 'border-gray-300');
            msg.classList.add('hidden');
            msg.innerText = "";

            if (status === 'error') {
                input.classList.add('border-red-500', 'focus:ring-red-500');
                msg.innerText = msgText;
                msg.classList.remove('hidden');
            } else if (status === 'success') {
                input.classList.add('border-green-500', 'focus:ring-green-500');
            } else {
                // Normal state (khi ƒëang g√µ m√† ch∆∞a ƒë·ªß)
                input.classList.add('border-gray-300', 'focus:ring-green-500');
            }
        }

        // H√ÄM X·ª¨ L√ù CHUNG
        function setupField(id) {
            const input = document.getElementById(id);
            const rule = VALIDATOR[id];

            // 1. S·ª∞ KI·ªÜN INPUT (ƒêang g√µ): Ch·ªâ b·∫Øt k√Ω t·ª± c·∫•m, x√≥a l·ªói ƒë·ªô d√†i
            input.addEventListener('input', function() {
                const val = this.value;
                
                // Check k√Ω t·ª± c·∫•m
                if (rule.forbidden.test(val)) {
                    // N·∫øu nh·∫≠p k√Ω t·ª± c·∫•m -> B√°o l·ªói ngay v√† kh√¥ng cho nh·∫≠p ti·∫øp (ho·∫∑c replace)
                    setStatus(id, 'error', rule.msg_forbidden);
                    // M·∫πo: T·ª± ƒë·ªông x√≥a k√Ω t·ª± c·∫•m ƒë·ªÉ tr·∫£i nghi·ªám t·ªët h∆°n (Optional)
                    // this.value = val.replace(rule.forbidden, ''); 
                    return; 
                }

                // N·∫øu ƒëang g√µ k√Ω t·ª± h·ª£p l·ªá -> Tr·∫£ v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng (x√≥a l·ªói c≈© n·∫øu c√≥)
                setStatus(id, 'normal');
                
                // Ri√™ng check Re-pass real-time
                if(id === 're_mat_khau' || id === 'mat_khau') checkRePass(false);
            });

            // 2. S·ª∞ KI·ªÜN BLUR (Click ra ngo√†i): Ch·ªët l·ªói ƒë·ªô d√†i/format
            input.addEventListener('blur', function() {
                const val = this.value;
                if(val === "") return; // N·∫øu r·ªóng th√¨ th√¥i (ƒë·ªÉ required html lo)

                if (!rule.validate(val)) {
                    setStatus(id, 'error', rule.msg_invalid);
                } else {
                    setStatus(id, 'success');
                }
            });
        }

        // Logic ri√™ng cho Nh·∫≠p l·∫°i m·∫≠t kh·∫©u
        function checkRePass(isBlur) {
            const p1 = document.getElementById('mat_khau').value;
            const p2 = document.getElementById('re_mat_khau').value;
            
            if (p2 === "") return;

            if (p1 !== p2) {
                // Ch·ªâ b√°o l·ªói khi blur ho·∫∑c khi p2 d√†i h∆°n p1 (r√µ r√†ng sai)
                if (isBlur || p2.length >= p1.length) {
                    setStatus('re_mat_khau', 'error', "M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.");
                }
            } else {
                setStatus('re_mat_khau', 'success');
            }
        }

        // K√≠ch ho·∫°t l·∫Øng nghe cho c√°c tr∆∞·ªùng
        ['ho_ten', 'email', 'ma_pin', 'ten_dang_nhap', 'mat_khau'].forEach(setupField);

        // L·∫Øng nghe ri√™ng cho Re-pass
        document.getElementById('re_mat_khau').addEventListener('input', () => checkRePass(false));
        document.getElementById('re_mat_khau').addEventListener('blur', () => checkRePass(true));

        function togglePass(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        // Ch·∫∑n submit n·∫øu c√≤n l·ªói ƒë·ªè
        document.getElementById('formDangKy').addEventListener('submit', function(e) {
            const errors = document.querySelectorAll('.border-red-500');
            if (errors.length > 0) {
                e.preventDefault();
                alert("Vui l√≤ng s·ª≠a c√°c th√¥ng tin b√°o l·ªói m√†u ƒë·ªè!");
            }
        });
    </script>

    {{ template "footer" . }}
{{ end }}
