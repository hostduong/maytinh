{{ define "ho_so" }}
    {{ template "header" . }}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="max-w-2xl mx-auto py-10">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
            
            <div class="bg-blue-500 h-32 relative"></div>
            <div class="text-center -mt-16 relative">
                <div class="inline-block p-1 bg-white rounded-full shadow-md">
                    <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center text-white text-4xl overflow-hidden">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ .NhanVien.TenDangNhap }}" alt="Avatar" class="w-full h-full">
                    </div>
                </div>
                <h2 class="mt-3 text-2xl font-bold text-gray-800" id="lblHoTen">
                    {{ .NhanVien.HoTen }}
                </h2>
                <p class="text-blue-500 font-medium">{{ .NhanVien.ChucVu }}</p>
            </div>

            <div class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase font-bold tracking-wider">M√£ th√†nh vi√™n</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded border border-gray-100 font-mono text-gray-700 font-semibold">
                            {{ .NhanVien.MaNhanVien }}
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase font-bold tracking-wider">T√™n ƒëƒÉng nh·∫≠p</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded border border-gray-100 text-gray-800">
                            {{ .NhanVien.TenDangNhap }}
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase font-bold tracking-wider">Email</label>
                    <div class="mt-1 text-lg text-gray-800 border-b border-gray-200 pb-1">
                        {{ if .NhanVien.Email }}{{ .NhanVien.Email }}{{ else }}<span class="text-gray-400 italic">Ch∆∞a c·∫≠p nh·∫≠t</span>{{ end }}
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase font-bold tracking-wider">Ng√†y tham gia</label>
                    <div class="mt-1 text-gray-600 text-sm">
                         {{ .NhanVien.LanDangNhapCuoi }}
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-8 py-6 border-t border-gray-100 flex flex-wrap justify-center gap-3">
                <button onclick="toggleModal('modalPass')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-0.5">
                    ƒê·ªïi m·∫≠t kh·∫©u
                </button>
                <button onclick="toggleModal('modalInfo')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-5 py-2.5 rounded-lg font-medium transition shadow-sm">
                    C·∫≠p nh·∫≠t th√¥ng tin
                </button>
                <button onclick="toggleModal('modalPin')" class="bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 px-5 py-2.5 rounded-lg font-medium transition">
                    ƒê·ªïi m√£ PIN
                </button>
            </div>
        </div>
    </div>

    <div id="modalPass" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4 text-gray-800">üîê ƒê·ªïi M·∫≠t Kh·∫©u</h3>
            <div class="space-y-3">
                <input type="password" id="oldPass" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                
                <div>
                    <input type="password" id="newPass" placeholder="M·∫≠t kh·∫©u m·ªõi" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <p id="err_newPass" class="text-red-500 text-xs mt-1 hidden">8-30 k√Ω t·ª±, kh√¥ng ch·ª©a k√Ω t·ª± c·∫•m.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalPass')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">H·ªßy</button>
                <button id="btnSavePass" onclick="doiPass()" disabled class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="modalInfo" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96">
            <h3 class="text-xl font-bold mb-4 text-gray-800">‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng tin</h3>
            <div class="space-y-3">
                <label class="text-sm text-gray-500">H·ªç v√† t√™n hi·ªÉn th·ªã</label>
                <div>
                    <input type="text" id="newName" value="{{ .NhanVien.HoTen }}" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <p id="err_newName" class="text-red-500 text-xs mt-1 hidden">6-50 k√Ω t·ª±, ch·ªâ ch·ª©a ch·ªØ.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalInfo')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">H·ªßy</button>
                <button id="btnSaveName" onclick="doiTen()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>

    <div id="modalPin" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96">
            <h3 class="text-xl font-bold mb-4 text-gray-800">üî¢ ƒê·ªïi M√£ PIN B·∫£o M·∫≠t</h3>
            <p class="text-xs text-gray-500 mb-3">M√£ PIN d√πng ƒë·ªÉ kh√¥i ph·ª•c m·∫≠t kh·∫©u khi qu√™n.</p>
            <div class="space-y-3">
                <input type="text" id="oldPin" maxlength="8" placeholder="M√£ PIN c≈©" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                
                <div>
                    <input type="text" id="newPin" maxlength="8" placeholder="M√£ PIN m·ªõi (8 s·ªë)" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                    <p id="err_newPin" class="text-red-500 text-xs mt-1 hidden">B·∫Øt bu·ªôc ƒë√∫ng 8 ch·ªØ s·ªë.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalPin')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">H·ªßy</button>
                <button id="btnSavePin" onclick="doiPin()" disabled class="bg-purple-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-purple-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">L∆∞u PIN</button>
            </div>
        </div>
    </div>

    <script>
        // Regex (ƒê·ªìng b·ªô v·ªõi h·ªá th·ªëng)
        const REGEX = {
            ho_ten: /^[\p{L}\s]{6,50}$/u,
            ma_pin: /^\d{8}$/,
            mat_khau: /^[^'"<>\s]{8,30}$/
        };

        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.firstElementChild.classList.add('scale-100'), 10);
            } else {
                modal.classList.add('hidden');
            }
        }

        // --- VALIDATION REAL-TIME ---
        
        // 1. Check ƒê·ªïi Pass
        document.getElementById('newPass').addEventListener('input', function() {
            const isValid = REGEX.mat_khau.test(this.value);
            const err = document.getElementById('err_newPass');
            const btn = document.getElementById('btnSavePass');
            
            if (!isValid) {
                this.classList.add('border-red-500', 'focus:ring-red-500');
                err.classList.remove('hidden');
                btn.disabled = true;
            } else {
                this.classList.remove('border-red-500', 'focus:ring-red-500');
                this.classList.add('border-green-500', 'focus:ring-green-500');
                err.classList.add('hidden');
                btn.disabled = false;
            }
        });

        // 2. Check ƒê·ªïi T√™n
        document.getElementById('newName').addEventListener('input', function() {
            this.value = this.value.replace(/[0-9]/g, ''); // X√≥a s·ªë
            const isValid = REGEX.ho_ten.test(this.value.trim());
            const err = document.getElementById('err_newName');
            const btn = document.getElementById('btnSaveName');

            if (!isValid) {
                this.classList.add('border-red-500');
                err.classList.remove('hidden');
                btn.disabled = true;
            } else {
                this.classList.remove('border-red-500');
                this.classList.add('border-green-500');
                err.classList.add('hidden');
                btn.disabled = false;
            }
        });

        // 3. Check ƒê·ªïi PIN
        document.getElementById('newPin').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, ''); // X√≥a ch·ªØ
            const isValid = REGEX.ma_pin.test(this.value);
            const err = document.getElementById('err_newPin');
            const btn = document.getElementById('btnSavePin');

            if (!isValid) {
                this.classList.add('border-red-500', 'focus:ring-red-500');
                err.classList.remove('hidden');
                btn.disabled = true;
            } else {
                this.classList.remove('border-red-500', 'focus:ring-red-500');
                this.classList.add('border-green-500', 'focus:ring-purple-500');
                err.classList.add('hidden');
                btn.disabled = false;
            }
        });

        // --- API CALLS ---
        async function postData(url, data) {
            const formData = new FormData();
            for(const k in data) formData.append(k, data[k]);
            try {
                const res = await fetch(url, { method: 'POST', body: formData });
                return await res.json();
            } catch (e) {
                return { status: 'error', msg: 'L·ªói k·∫øt n·ªëi server!' };
            }
        }

        async function doiPass() {
            const res = await postData('/api/user/change-pass', {
                pass_cu: document.getElementById('oldPass').value,
                pass_moi: document.getElementById('newPass').value
            });
            handleRes(res, 'modalPass', ['oldPass', 'newPass']);
        }

        async function doiTen() {
            const newName = document.getElementById('newName').value;
            const res = await postData('/api/user/update-info', { ho_ten_moi: newName });
            if(res.status === 'ok') {
                document.getElementById('lblHoTen').innerText = newName;
            }
            handleRes(res, 'modalInfo', []);
        }

        async function doiPin() {
            const res = await postData('/api/user/change-pin', {
                pin_cu: document.getElementById('oldPin').value,
                pin_moi: document.getElementById('newPin').value
            });
            handleRes(res, 'modalPin', ['oldPin', 'newPin']);
        }

        function handleRes(res, modalId, clearIds) {
            if(res.status === 'ok') {
                Swal.fire({ icon: 'success', title: 'Th√†nh c√¥ng', text: res.msg, timer: 1500, showConfirmButton: false });
                clearIds.forEach(id => document.getElementById(id).value = '');
                toggleModal(modalId);
                // Reset border colors
                clearIds.forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.remove('border-green-500', 'border-red-500');
                });
            } else {
                Swal.fire({ icon: 'error', title: 'L·ªói', text: res.msg });
            }
        }
    </script>

    {{ template "footer" . }}
{{ end }}
