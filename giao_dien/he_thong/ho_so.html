{{ define "ho_so" }}
    {{ template "header" . }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="max-w-2xl mx-auto py-10 px-4">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
            <div class="bg-blue-500 h-32 relative"></div>
            <div class="text-center -mt-16 relative">
                 <div class="inline-block p-1 bg-white rounded-full shadow-md">
                    <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center text-white text-4xl overflow-hidden">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ .NhanVien.TenDangNhap }}" alt="Avatar" class="w-full h-full">
                    </div>
                </div>
                <h2 class="mt-3 text-2xl font-bold text-gray-800" id="lblHoTen">{{ .NhanVien.TenKhachHang }}</h2>
                <p class="text-blue-500 font-medium">{{ .NhanVien.ChucVu }}</p>
            </div>
            <div class="bg-gray-50 px-8 py-6 border-t border-gray-100 flex flex-wrap justify-center gap-3">
                <button onclick="toggleModal('modalPass')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform active:scale-95">ƒê·ªïi m·∫≠t kh·∫©u</button>
                <button onclick="toggleModal('modalInfo')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-5 py-2.5 rounded-lg font-medium transition transform active:scale-95">C·∫≠p nh·∫≠t th√¥ng tin</button>
                <button onclick="toggleModal('modalPin')" class="bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 px-5 py-2.5 rounded-lg font-medium transition transform active:scale-95">ƒê·ªïi m√£ PIN</button>
            </div>
        </div>
    </div>

    <div id="modalPass" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4 text-gray-800">üîê ƒê·ªïi M·∫≠t Kh·∫©u</h3>
            <div class="space-y-3">
                <input type="password" id="oldPass" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div>
                    <input type="password" id="newPass" placeholder="M·∫≠t kh·∫©u m·ªõi (min 8 k√Ω t·ª±)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <p id="err_newPass" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalPass')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg">H·ªßy</button>
                <button id="btnSavePass" onclick="doiPass()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md">L∆∞u</button>
            </div>
        </div>
    </div>

    <div id="modalInfo" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4 text-gray-800">‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng tin</h3>
            <div class="space-y-3">
                <label class="text-sm text-gray-500">H·ªç v√† t√™n hi·ªÉn th·ªã</label>
                <div>
                    <input type="text" id="newName" value="{{ .NhanVien.TenKhachHang }}" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <p id="err_newName" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalInfo')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg">H·ªßy</button>
                <button id="btnSaveName" onclick="doiTen()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>

    <div id="modalPin" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4 text-gray-800">üî¢ ƒê·ªïi M√£ PIN</h3>
            <div class="space-y-3">
                <input type="text" id="oldPin" maxlength="8" placeholder="M√£ PIN c≈©" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <div>
                    <input type="text" id="newPin" maxlength="8" placeholder="M√£ PIN m·ªõi (8 s·ªë)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                    <p id="err_newPin" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleModal('modalPin')" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg">H·ªßy</button>
                <button id="btnSavePin" onclick="doiPin()" class="bg-purple-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-purple-700 shadow-md">L∆∞u PIN</button>
            </div>
        </div>
    </div>

    <script>
        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Animation nh·∫π
                setTimeout(() => modal.firstElementChild.classList.remove('scale-95', 'opacity-0'), 10);
                setTimeout(() => modal.firstElementChild.classList.add('scale-100', 'opacity-100'), 10);
            } else {
                modal.firstElementChild.classList.remove('scale-100');
                modal.firstElementChild.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 150);
            }
        }

        // H√ÄM KI·ªÇM TRA CHUNG
        function setupValidation(id, forbiddenRegex, validateFunc, msgError, msgForbidden) {
            const input = document.getElementById(id);
            const err = document.getElementById('err_' + id);
            
            input.addEventListener('input', function() {
                const val = this.value;
                if (forbiddenRegex && forbiddenRegex.test(val)) {
                    this.classList.add('border-red-500');
                    err.innerText = msgForbidden;
                    err.classList.remove('hidden');
                } else {
                    this.classList.remove('border-red-500', 'border-green-500');
                    this.classList.add('border-blue-500');
                    err.classList.add('hidden');
                }
            });

            input.addEventListener('blur', function() {
                const val = this.value;
                if (val === "") return;

                if (!validateFunc(val)) {
                    this.classList.add('border-red-500');
                    err.innerText = msgError;
                    err.classList.remove('hidden');
                } else {
                    this.classList.remove('border-red-500', 'border-blue-500');
                    this.classList.add('border-green-500');
                    err.classList.add('hidden');
                }
            });
        }

        // 1. Validate ƒê·ªïi Pass
        setupValidation('newPass', /['"<>\s]/, 
            val => val.length >= 8 && val.length <= 30, 
            "M·∫≠t kh·∫©u ph·∫£i t·ª´ 8-30 k√Ω t·ª±.", 
            "Kh√¥ng ƒë∆∞·ª£c ch·ª©a kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát.");

        // 2. Validate ƒê·ªïi T√™n
        setupValidation('newName', /[0-9!@#$%^&*(),.?":{}|<>]/, 
            val => val.trim().length >= 6 && val.trim().length <= 50, 
            "H·ªç t√™n ph·∫£i t·ª´ 6-50 k√Ω t·ª±.", 
            "H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ch·ª©a s·ªë/k√Ω t·ª± l·∫°.");

        // 3. Validate ƒê·ªïi PIN
        setupValidation('newPin', /[^0-9]/, 
            val => /^\d{8}$/.test(val), 
            "M√£ PIN b·∫Øt bu·ªôc ph·∫£i ƒë√∫ng 8 s·ªë.", 
            "M√£ PIN ch·ªâ ƒë∆∞·ª£c nh·∫≠p s·ªë.");

        // --- API CALLS ---
        async function postData(url, data) {
            const formData = new FormData();
            for(const k in data) formData.append(k, data[k]);
            try {
                const res = await fetch(url, { method: 'POST', body: formData });
                return await res.json();
            } catch (e) { return { status: 'error', msg: 'L·ªói server!' }; }
        }

        async function doiPass() {
            if(document.getElementById('newPass').classList.contains('border-red-500')) return;
            const res = await postData('/api/user/change-pass', {
                pass_cu: document.getElementById('oldPass').value,
                pass_moi: document.getElementById('newPass').value
            });
            handleRes(res, 'modalPass', ['oldPass', 'newPass']);
        }

        async function doiTen() {
            if(document.getElementById('newName').classList.contains('border-red-500')) return;
            const newName = document.getElementById('newName').value;
            const res = await postData('/api/user/update-info', { ho_ten_moi: newName });
            if(res.status === 'ok') document.getElementById('lblHoTen').innerText = newName;
            handleRes(res, 'modalInfo', []);
        }

        async function doiPin() {
            if(document.getElementById('newPin').classList.contains('border-red-500')) return;
            const res = await postData('/api/user/change-pin', {
                pin_cu: document.getElementById('oldPin').value,
                pin_moi: document.getElementById('newPin').value
            });
            handleRes(res, 'modalPin', ['oldPin', 'newPin']);
        }

        function handleRes(res, modalId, clearIds) {
            if(res.status === 'ok') {
                Swal.fire({ icon: 'success', title: 'Th√†nh c√¥ng', text: res.msg, timer: 1500, showConfirmButton: false });
                clearIds.forEach(id => document.getElementById(id).value = '');
                toggleModal(modalId);
            } else {
                Swal.fire({ icon: 'error', title: 'L·ªói', text: res.msg });
            }
        }
    </script>
    {{ template "footer" . }}
{{ end }}
